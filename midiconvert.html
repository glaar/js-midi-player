<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Tone.js example</title>
    <script src="lib/Tone.js"></script>
    <script src="lib/MidiConvert.js"></script>
    <script src="notegrid/draw.js"></script>
</head>
<body>
<canvas width="12000" height="800" id="notegrid" style="border:1px solid #c3c3c3;"></canvas>

<div id='content'>
    <p>Check to play:</p>
    <input type='checkbox' class='playToggle'> Transport time: <span id='seconds'>0</span>
</div>

<script>
    let synth = new Tone.PolySynth(8).toMaster();
    let canvas = document.getElementById('notegrid');
    let ctx = canvas.getContext('2d');




    MidiConvert.load("TCPBC jingle.mid", function(midi) {
        console.log(midi.tracks);


        drawNoteGrid(ctx);
        ctx.globalAlpha = 0.7;
        for (let track of midi.tracks){
            for (let note of track.notes){
                drawNote(note, track.channelNumber);
            }
        }
        //

        // make sure you set the tempo before you schedule the events
        Tone.Transport.bpm.value = midi.header.bpm;

        // pass in the note events from one of the tracks as the second argument to Tone.Part
        let midiPart = new Tone.Part(
            function(time, note) {
                //use the events to play the synth
                synth.triggerAttackRelease(note.name, note.duration, time, note.velocity)
            },
            midi.tracks[3].notes
        ).start();

    });

    function updateTime(){
        let seconds = Tone.Transport.seconds.toFixed(2);

        requestAnimationFrame(updateTime);
        //Tries to draw animate the playhead
        requestAnimationFrame(drawPlayhead);
        //the time elapsed in seconds
        document.querySelector('#seconds').textContent = seconds;
    }

    updateTime();

    //start/stop the transport
    document.querySelector('.playToggle').addEventListener('change', function(e){
        if (e.target.checked){
            Tone.Transport.start()
        } else {
            Tone.Transport.stop()
        }
    });

    //Tries to draw playhead
    function drawPlayhead(){

        let seconds = Tone.Transport.seconds.toFixed(2);
        let x = parseInt(seconds);

        ctx.moveTo(x,0);
        ctx.lineTo(x, canvas.height);
    };

</script>
</body>
</html>
