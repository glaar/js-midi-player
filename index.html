<!DOCTYPE html>
<html>
    <head>
        <title>midi.js</title>
        <script src="lib/jquery-3.2.1.min.js"></script>
        <script src="midi.js"></script>
        <script src="synth.js"></script>
    </head>
    <body>
        <canvas width="1200" height="800" id="that-canvas"></canvas>

        <script src="midi_base64.php?filename=TCPBC%20jingle.mid"></script>
        <script>
            //var song = atob("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");
            var midi = new Midi(song);
            var mixer = new Mixer();
            midi.add_callback(
              function(e) {
                mixer.handle_event(e);
              }
            );

            function noteNumberToNote(note_number){
                var note = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
                return note[note_number%12];
            }

            var canvas = document.getElementById('that-canvas');
            var ctx = canvas.getContext('2d');

            var drawEvent = function(e) {
              var midiChannel = e.midi_channel;
              var noteNumber = e.note_number;
              var gridSize = 20;
              var boxSize = 30;

              if (midiChannel === 0 && e.type == 0x9) {	//note on
                canvas.width = canvas.width;

                //Drawing notegridd
                for(var i = 0; i < gridSize + 6; i++){
                    ctx.strokeRect(10, 50+i*boxSize, boxSize, boxSize);

                    ctx.save();
                    ctx.beginPath();
                    ctx.moveTo(900,50+i*boxSize);
                    ctx.lineTo(10,50+i*boxSize);
                    ctx.strokeStyle = 'grey';
                    ctx.stroke();
                    ctx.restore();

                    ctx.fillText(noteNumberToNote(62-i),20,70+(i*boxSize));
                }
                ctx.fillRect(70, 50+(19-(noteNumber-43))*boxSize, boxSize, boxSize);

              }
            };
            midi.add_callback(drawEvent);
            mixer.start();
        </script>
    </body>
</html>
